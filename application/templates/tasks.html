<html lang="lt">
<head>
    <title>Headquarter console: tasks</title>
    <link rel="icon" type="image/x-icon" href="/assets/img/favicon.ico">
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/task.js"></script>
    <script src="/assets/js/tasks-component.js"></script>
    <script src="/assets/js/dispatcher.js"></script>
    <script src="/assets/js/participant.js"></script>
    <script src="/assets/js/api.js"></script>
    <script src="/assets/js/settings.js"></script>
    <link rel="stylesheet" type="text/css" href="/assets/css/stabas.css"/>
</head>
<body>
{{ .menu}}

<div id="app">
    <div id="tasksList" class="tasks-list">

    </div>
    <div id="taskDetails2" class="task-details">
    </div>
</div>
<script type="application/javascript">
    let dispatcher = new Dispatcher();
    let redrawTasksList = null;
    let tasksComponent = null;
    let apiClient = new ApiClient();
    let reloadAndRedrawTasksList = null;
    let verboseConsole = false

    // TODO move this block to a separate js file from here
    apiClient.callback401 = (response) => {
        dispatcher.dispatch('handle401', response)
    }

    dispatcher.addListener('handle401', (response) => {
        console.log('dispatcher handling 401', response)
        response.json().then((data) => {
            // console.log('dispatcher 401 response content:', data)
            let message = data.error || "Unauthenticated request"
            alert(message)
            window.location.href = '/login';
        })
    })

    apiClient.getUser().then((userData) => {
        let userDataElement = document.getElementById('current-user-data')
        clearTag(userDataElement)
        userDataElement.appendChild(document.createTextNode(userData.id + ': ' + userData.name))
    })
    // TILL here

    TasksComponent.initialize(dispatcher, apiClient).then(
        (tc) => {
            tasksComponent = tc;

            // console.log('tasks.html[28], tasks amount', tasksComponent.tasks.length )
            redrawTasksList = () => {
                let tasksListDiv = document.getElementById('tasksList');
                clearTag(tasksListDiv);
                tasksListDiv.appendChild(tasksComponent.renderTasks());
            }

            reloadAndRedrawTasksList = () => tasksComponent.reloadSettings().then(() =>
                tasksComponent.reloadParticipants().then(() =>
                    tasksComponent.reloadTasks().then(() => redrawTasksList())
                )
            )

            redrawTasksList();
            initializeListeners(tasksComponent)
        }
    );

    // =================== Make task details draggable ===================================
    function makeDraggable(outerDiv) {
        let dragHandle = outerDiv.querySelector('.task-details-drag-handle');
        if (!dragHandle) return;

        let isDragging = false;
        let currentX, currentY, initialX, initialY;

        dragHandle.addEventListener('mousedown', (e) => {
            isDragging = true;
            initialX = e.clientX - outerDiv.offsetLeft;
            initialY = e.clientY - outerDiv.offsetTop;
            dragHandle.style.cursor = 'grabbing';
        });

        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;

            e.preventDefault();
            currentX = e.clientX - initialX;
            currentY = e.clientY - initialY;

            outerDiv.style.left = currentX + 'px';
            outerDiv.style.top = currentY + 'px';
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            dragHandle.style.cursor = 'move';
        });
    }

    // =================== events initialization ===================================
    function initializeListeners(tasksComponent) {
        const taskDetailsOuterDiv = document.getElementById('taskDetails2')

        dispatcher.addListener('taskSaved', (task) => {
            // console.log('Task saved ' + task.id)
            redrawTasksList()
            let taskDetailsDiv = task.renderTaskDetailsFull(null, () => tasksComponent.participants);
            dispatcher.dispatch('taskDetailsRendered', taskDetailsDiv)
            tasksComponent.disableSaveButton();
        })

        dispatcher.addListener('taskSavedPartially', (task) => {
            console.log('Task saved partially ' + task.id)
            alert('Was changes from another editor, look/modify values and save again.')
            redrawTasksList()

            let taskDetailsDiv = task.renderTaskDetailsFull(null, () => tasksComponent.participants);
            dispatcher.dispatch('taskDetailsRendered', taskDetailsDiv)
            tasksComponent.enableSaveButton();
        })

        dispatcher.addListener('taskDetailsRendered', (taskInnerDiv) => {
            clearTag(taskDetailsOuterDiv)
            taskDetailsOuterDiv.appendChild(taskInnerDiv)
            makeDraggable(taskDetailsOuterDiv);
        })

        dispatcher.addListener('onViewTaskDetails', () => {
            taskDetailsOuterDiv.style.display = 'block'
        })


        dispatcher.addListener('deleteTaskPressed', ([e, taskId]) => tasksComponent.deleteTask(e, taskId))

        dispatcher.addListener('afterAddTask', () => {
            redrawTasksList();
            clearTag(taskDetailsOuterDiv)
        })

        dispatcher.addListener('afterDeleteTask', (taskId) => {
            if (verboseConsole) {
                console.log('afterDeleteTask listener is called with taskId=' + taskId)
            }
            redrawTasksList();
            clearTag(taskDetailsOuterDiv)
        })

        dispatcher.addListener('inputReceivers', ([e, taskId]) => {
            if (verboseConsole) {
                console.log('task ' + taskId + ' receivers input', e)
            }
            tasksComponent.enableSaveButton()
        })

        dispatcher.addListener('inputSender', ([e, taskId]) => {
            if (verboseConsole) {
                console.log('task ' + taskId + ' sender input', e)
            }
            tasksComponent.enableSaveButton()
        })

        dispatcher.addListener('inputStatus', ([e, taskId]) => {
            if (verboseConsole) {
                console.log('task ' + taskId + ' status input', e)
            }
            tasksComponent.enableSaveButton()
        })

        dispatcher.addListener('inputMessage', ([e, taskId]) => {
            if (verboseConsole) {
                console.log('task ' + taskId + ' message input', e)
            }
            tasksComponent.enableSaveButton()
        })

        dispatcher.addListener('inputResult', ([e, taskId]) => {
            if (verboseConsole) {
                console.log('task ' + taskId + ' result input', e)
            }
            tasksComponent.enableSaveButton()
        });

        dispatcher.addListener('afterChangeStatus', ([e, task]) => {
            if (verboseConsole) {
                console.log('afterChangeStatus called with ', e, task)
            }
            // may be reloading function is better inside a Task ..
            tasksComponent.reloadSingleTask(task).then(() => {
                redrawTasksList()
            });
        });

        dispatcher.addListener('hideDetailsPressed', (e) => {
            if (verboseConsole) {
                console.log('hideDetailsPressed ', e)
            }
            taskDetailsOuterDiv.style.display = 'none'
        });

        dispatcher.addListener('timerTick', () => {
            // console.log('timerTick called')

            if (tasksComponent.settings.reloadTasksOnTimer) {
                tasksComponent.reloadSettings().then(() =>
                    tasksComponent.reloadParticipants().then(() =>
                        tasksComponent.loadTasks().then(() => redrawTasksList())
                    )
                )
            }
        })

        dispatcher.addListener('onChangeTaskStatus', ([task, newStatus]) => {
            tasksComponent.handleChangeTaskStatus(task, newStatus)
        })

        dispatcher.addListener('onSaveTask', ([e, task, myVersionDto]) => {
            tasksComponent.handleUpdateTask(e, task, myVersionDto)
        })

        dispatcher.addListener('taskSelected', (task) => {
            tasksComponent.selectTask(task)
        })

        dispatcher.addListener('reloadPressed', () => {
            reloadAndRedrawTasksList()
        })

    }

    // =============================================================================

</script>
</body>
</html>